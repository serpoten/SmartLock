Most of the code taken from CameronK github